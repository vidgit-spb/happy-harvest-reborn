# Happy Harvest Reborn - Backend API

–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å –∏–≥—Ä—ã Happy Harvest Reborn, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º NestJS, TypeORM, WebSockets –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å Telegram API.

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **NestJS** - –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π Node.js —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- **TypeORM** - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- **Socket.IO** - –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **Telegram Bot API** - –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **tRPC** - –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ API –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º
- **Redis** - –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ pub/sub —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
api/
‚îú‚îÄ‚îÄ src/                   # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ admin/             # –ú–æ–¥—É–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ animal/            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ building/          # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–¥–∞–Ω–∏—è–º–∏ –∏ —Ñ–∞–±—Ä–∏–∫–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ garden/            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∞–¥–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ plot/              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—è–¥–∫–∞–º–∏ –∏ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ star/              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤–µ–∑–¥–∞–º–∏ (–ø—Ä–µ–º–∏—É–º –≤–∞–ª—é—Ç–∞)
‚îÇ   ‚îú‚îÄ‚îÄ telegram/          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram
‚îÇ   ‚îú‚îÄ‚îÄ tree/              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ä–µ–≤—å—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ trpc/              # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tRPC —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ websocket/         # WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
‚îÇ   ‚îú‚îÄ‚îÄ app.controller.ts  # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts      # –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ app.service.ts     # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îî‚îÄ‚îÄ main.ts            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ test/                  # –¢–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ tsconfig.json          # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ TypeScript
‚îî‚îÄ‚îÄ package.json           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã
```

## üåê API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /auth/login` - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
- `GET /auth/me` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

### –°–∞–¥—ã
- `GET /garden` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–∞–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /garden` - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–∞–¥–∞
- `GET /garden/:id` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∞–¥–µ
- `POST /garden/:id/join` - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Å–∞–¥—É
- `POST /garden/:id/leave` - –í—ã—Ö–æ–¥ –∏–∑ —Å–∞–¥–∞

### –ì—Ä—è–¥–∫–∏
- `POST /plot/plant` - –ü–æ—Å–∞–¥–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è
- `POST /plot/water` - –ü–æ–ª–∏–≤ —Ä–∞—Å—Ç–µ–Ω–∏—è
- `POST /plot/harvest` - –°–±–æ—Ä —É—Ä–æ–∂–∞—è
- `POST /plot/steal` - –ü–æ–ø—ã—Ç–∫–∞ –∫—Ä–∞–∂–∏ —É—Ä–æ–∂–∞—è
- `POST /plot/remove-weed` - –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ä–Ω—è–∫–æ–≤

### –ñ–∏–≤–æ—Ç–Ω—ã–µ
- `POST /animal/purchase` - –ü–æ–∫—É–ø–∫–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
- `POST /animal/feed/:animalId` - –ö–æ—Ä–º–ª–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
- `GET /animal/garden/:gardenId` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ —Å–∞–¥—É
- `POST /animal/move` - –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ
- `POST /animal/sell/:animalId` - –ü—Ä–æ–¥–∞–∂–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ

### –î–µ—Ä–µ–≤—å—è
- `POST /tree/plant` - –ü–æ—Å–∞–¥–∫–∞ –¥–µ—Ä–µ–≤–∞
- `POST /tree/harvest/:treeId` - –°–±–æ—Ä —Ñ—Ä—É–∫—Ç–æ–≤ —Å –¥–µ—Ä–µ–≤–∞
- `GET /tree/garden/:gardenId` - –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ä–µ–≤—å–µ–≤ –≤ —Å–∞–¥—É
- `POST /tree/remove/:treeId` - –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞

### –ó–¥–∞–Ω–∏—è
- `POST /building/build` - –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∑–¥–∞–Ω–∏—è
- `POST /building/production/start` - –ó–∞–ø—É—Å–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
- `POST /building/production/collect/:buildingId` - –°–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ü–∏–∏
- `GET /building/garden/:gardenId` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–¥–∞–Ω–∏–π –≤ —Å–∞–¥—É
- `POST /building/demolish/:buildingId` - –°–Ω–æ—Å –∑–¥–∞–Ω–∏—è

### –ó–≤–µ–∑–¥—ã (–ø—Ä–µ–º–∏—É–º –≤–∞–ª—é—Ç–∞)
- `GET /star/balance` - –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∑–≤–µ–∑–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /star/purchase` - –ü–æ–∫—É–ø–∫–∞ –∑–≤–µ–∑–¥
- `GET /star/transactions` - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### WebSocket –°–æ–±—ã—Ç–∏—è
- `garden-update` - –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–∞–¥—É
- `plot-update` - –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—è–¥–æ–∫
- `theft-attempt` - –ü–æ–ø—ã—Ç–∫–∞ –∫—Ä–∞–∂–∏ —É—Ä–æ–∂–∞—è
- `level-up` - –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
- `garden:message` - –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ —Å–∞–¥–∞

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pnpm install
```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ PostgreSQL –∏ Redis (–∏—Å–ø–æ–ª—å–∑—É—è Docker Compose):
```bash
docker-compose up -d postgres redis
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ API:
```bash
pnpm --filter api dev
```

4. API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://localhost:3000

### –°–±–æ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞:
```bash
pnpm --filter api build
```

2. –î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ production —Ä–µ–∂–∏–º–µ:
```bash
pnpm --filter api start:prod
```

## üì¶ –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
pnpm --filter api migration:generate src/migrations/–Ω–∞–∑–≤–∞–Ω–∏–µ-–º–∏–≥—Ä–∞—Ü–∏–∏
```

2. –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π:
```bash
pnpm --filter api migration:run
```

3. –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π:
```bash
pnpm --filter api migration:revert
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞
1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –≤ Telegram
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
3. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `TG_BOT_TOKEN`

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Mini App
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ @BotFather –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Web App –¥–ª—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
2. –£–∫–∞–∂–∏—Ç–µ URL –≤–∞—à–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. –î–æ–±–∞–≤—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `TG_APP_NAME`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- –í—Å–µ API-–∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
- –î–æ—Å—Ç—É–ø–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç `/health` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–µ–π—Å—Ç–≤–∏–π

## üß™ –¢–µ—Å—Ç—ã

–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤:
```bash
pnpm --filter api test
```

–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º:
```bash
pnpm --filter api test:cov
```
